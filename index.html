<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Планирование транспорта</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:system-ui;padding:20px;background:#eef2ff}
h1{color:#1e40af}
select,input,button{padding:6px}
table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff}
th,td{border:1px solid #ccc;padding:6px}
th{background:#e0ecff}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.btn{background:#2563eb;color:#fff;border:none;border-radius:6px;cursor:pointer}
.btn.red{background:#dc2626}
</style>
</head>

<body>
<h1>Планирование развозки (Firestore)</h1>

<div class="controls">
  <select id="deptFilter">
    <option value="">Все участки</option>
  </select>

  <input id="search" placeholder="Поиск ФИО">

  <button id="addBtn" class="btn">+ Добавить</button>
</div>

<table>
<thead>
<tr>
<th>ФИО</th>
<th>Участок</th>
<th>Общежитие</th>
<th>Откуда</th>
<th>Куда</th>
<th></th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyB8vMgNgtbrGPf21SeGsxhCaeeS3DLuzEc",
  authDomain: "transpotkit.firebaseapp.com",
  projectId: "transpotkit",
  storageBucket: "transpotkit.firebasestorage.app",
  messagingSenderId: "276561044748",
  appId: "1:276561044748:web:8de739a57f964944559529",
  measurementId: "G-5BDNMYC33X"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

/* ---------------- DATA ---------------- */
const departments = [
  "ЛЦП №1","ЛЦП №2","ЛЦП№3","Потолки","Арм.производство",
  "Цех подготовки","СТК","ВИС","ЭОМ","БСЦ","Кровля","Фасад"
];

const dorms = [
  "Общежитие Летово","Общежитие Мытищи","Общежитие Плещеева",
  "Общежитие Бекасово","Общежитие Марушкино","Общежитие Советская 4"
];

const places = [
  "Завод Марушкино","Яковлево","9я Северная","Новохохловская",
  "Таруса","Черемушки","Королев/Коммунарка","Дом"
];

let employees = [];

/* ---------------- UI ---------------- */
const tbody = document.getElementById("tbody");
const deptFilter = document.getElementById("deptFilter");
const search = document.getElementById("search");

departments.forEach(d=>{
  const o=document.createElement("option");
  o.value=o.textContent=d;
  deptFilter.appendChild(o);
});

/* ---------------- REALTIME LOAD ---------------- */
onSnapshot(col, snap=>{
  employees = snap.docs.map(d=>({id:d.id,...d.data()}));
  render();
});

/* ---------------- RENDER ---------------- */
function render(){
  let list=[...employees];

  if(deptFilter.value)
    list=list.filter(e=>e.department===deptFilter.value);

  if(search.value)
    list=list.filter(e=>e.fullName?.toLowerCase().includes(search.value.toLowerCase()));

  tbody.innerHTML=list.map(e=>`
    <tr>
      <td><input value="${e.fullName||""}" data-id="${e.id}" data-f="fullName"></td>
      <td>${sel(departments,e.department,e.id,"department")}</td>
      <td>${sel(dorms,e.dorm,e.id,"dorm")}</td>
      <td>${sel(places,e.from,e.id,"from")}</td>
      <td>${sel(places,e.to,e.id,"to")}</td>
      <td><button class="btn red" data-del="${e.id}">×</button></td>
    </tr>
  `).join("");
}

function sel(arr,val,id,f){
  return `<select data-id="${id}" data-f="${f}">
    <option value=""></option>
    ${arr.map(x=>`<option ${x===val?"selected":""}>${x}</option>`).join("")}
  </select>`;
}

/* ---------------- EVENTS ---------------- */
tbody.addEventListener("change", async e=>{
  const id=e.target.dataset.id;
  const f=e.target.dataset.f;
  if(!id||!f)return;
  await updateDoc(doc(db,"employees",id),{[f]:e.target.value});
});

tbody.addEventListener("input", async e=>{
  const id=e.target.dataset.id;
  const f=e.target.dataset.f;
  if(f!=="fullName")return;
  await updateDoc(doc(db,"employees",id),{fullName:e.target.value});
});

tbody.addEventListener("click", async e=>{
  if(!e.target.dataset.del)return;
  await deleteDoc(doc(db,"employees",e.target.dataset.del));
});

document.getElementById("addBtn").onclick=async()=>{
  await addDoc(col,{
    fullName:"",
    department:deptFilter.value||"",
    dorm:"",
    from:"",
    to:""
  });
};

deptFilter.onchange=render;
search.oninput=render;

</script>
</body>
</html>


